package com.idsspl.webproject.controller;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;

import com.idsspl.webproject.entity.AgentEntity;
import com.idsspl.webproject.model.AgentModel;
import com.idsspl.webproject.model.CustomerModel;
import com.idsspl.webproject.model.UserModel;
import com.idsspl.webproject.repo.AgentRepo;
import com.idsspl.webproject.repo.UserRepo;
import com.idsspl.webproject.service.AgentService;
import com.idsspl.webproject.service.CustomerService;
import com.idsspl.webproject.serviceImpl.UserServiceImpl;

@Controller
public class UserController {

	@Autowired
	private AgentService agentService;
	
	@Autowired
	private CustomerService customerService;

	// TO GET THE USERNAME OF THE USER LOGIN TO DISPLAY AND USE IN ALL THE ROUTES
	@ModelAttribute("userName")
	public String addUserNameToModel(Model model) {
		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
		if (authentication != null && authentication.isAuthenticated()) {
			return authentication.getName();
		}
		return null;
	}

	// GET LOGIN PAGE
	@GetMapping(path = "/login")
	public String GetLoginForm(Model model) {
		model.addAttribute("loginError", true);
		return "Login";
	}

	// TO GET ERROR PAGE
	@GetMapping(path = "/logout")
	public String Logout(Model model) {
		return "redirect:/";
	}

	// SET DEFAULT PAGE AS LOGIN
	@GetMapping(path = "/")
	public String GetDefaultPage(Model model) {
		return "redirect:/login";
	}

	// TO GET ERROR PAGE
	@GetMapping(path = "/error")
	public String ErrorPage(Model model) {
		return "Error";
	}

	// TO GET HOME PAGE
	@GetMapping(path = "/home")
	public String HomePage(Model model) {
		return "Home";
	}

//	// TO GET HOME PAGE
//	@GetMapping(path = "/home")
//	public String HomePage(Model model, Authentication authentication) {
//		String userName = authentication.getName();
//		model.addAttribute("userName", userName);
//		return "Home";
//	}

	// TO GET VIEW AGENT PAGE
	@GetMapping(path = "/viewAgent")
	public String GetViewAgentPage(Model model) {
		return "ViewAgent";
	}

	// TO GET AGENT LIST ON VIEW AGENT PAGE
	@PostMapping(path = "/viewAgentList")
	public String PostViewAgentPage(AgentModel agent, Model model) {
		List<AgentModel> agents;
		agents = agentService.getAgentsList(agent);
		System.out.println("agent======" + agents);
		if (agents == null || agents.isEmpty()) {
			String isDataMissing = "No data Found!";
			model.addAttribute("isDataMissing", isDataMissing);
		} else if (agents != null || !agents.isEmpty()) {
			System.out.println("--------------"+agents.get(0));
			model.addAttribute("agentList", agents);
		}
		return "ViewAgent";
	}

	// TO GET VIEW AGENT PAGE
	@GetMapping(path = "/viewCustomer")
	public String GetViewCustomerPage(Model model) {
		return "ViewCustomer";
	}
	
	@PostMapping(path = "/viewCustomerInfo")
	public String GetViewCustomerInfo(CustomerModel customer, Model model) {
		List<CustomerModel> customers;
		customers = customerService.getCustomerList(customer);
		if (customers == null || customers.isEmpty()) {
			String isDataMissing = "No data Found!";
			model.addAttribute("isDataMissing", isDataMissing);
		} else if (customers != null || !customers.isEmpty()) {
//			System.out.println("heheheheheheheheeh----"+customers.get(0).getSignature());
			model.addAttribute("customerList", customers);
		}
		return "ViewCustomer";
	}
	
//	@PostMapping("/saveAgentList")
//	public String saveAgentList(@ModelAttribute("agentList") List<AgentModel> agentList) {
//	    for (AgentModel agent : agentList) {
//	        agent.setCollectionAmount(agent.getCollectionAmount());
//	        agentService.saveAgent(agent);
//	    }
//	    return "redirect:/viewAgentList";
//	}

//	// TO GET AGENT LIST ON VIEW AGENT PAGE
//	@PostMapping(path = "/updateAgent")
//	public String updateAgent(@ModelAttribute("agent") AgentModel agentList) {
//		System.out.println("sdfdsfdfds---------" + agentList);
////	    for (AgentModel agent : agentList) {
////	    	System.out.println("heheheheheh-----"+agent.getAccountCode());
//////	        Long id = agent.getCustomerId();
//////	        Agent existingAgent = agentRepository.findById(id).orElse(null);
//////	        if (existingAgent != null) {
//////	            existingAgent.setLedgerbalance(agent.getLedgerbalance());
//////	            agentRepository.save(existingAgent);
//////	        }
////	    }
//		return "redirect:/viewAgent";
//	}

//	@PostMapping(path ="/updateAgent")
//	public String updateAgent(AgentModel agentList) {
//		System.out.println("hehehehehehehe---"+agentList);
//		System.out.println("jejejeje----"+agentList.getAccountCode());
//	    return "redirect:/viewAgent";
//	}

	@GetMapping(path = "/hello")
	public String sayHello(Model model) {
		String username = agentService.sayHello();
		model.addAttribute("username", username);
		return "hello";
	}
}
