package com.idsspl.webproject.serviceImpl;

import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import com.idsspl.webproject.entity.CollectionInfoEntity;
import com.idsspl.webproject.entity.Denomination;
import com.idsspl.webproject.entity.DenominationViewEntity;
import com.idsspl.webproject.entity.UserEntity;
import com.idsspl.webproject.model.CollectionInfoModel;
import com.idsspl.webproject.model.DenominationRequest;
import com.idsspl.webproject.repo.DenominationRepository;
import com.idsspl.webproject.repo.DenominationViewRepository;
import com.idsspl.webproject.repo.UserRepo;

@Service

public class DenominationServiceImpl {

	@Autowired
	private DenominationRepository denominationRepository;
	
	@Autowired
	private DenominationViewRepository denominationviewRepository;

	@Autowired
	private UserRepo userRepo;

	public void save(DenominationRequest request, String userName) {
		
			Denomination entity = new Denomination();
			///// TO GENERATE THE RANDOM UNIQUE ID
			String CHARACTERS = "0123456789";
			Random random = new Random();
			StringBuilder sb = new StringBuilder(10);
			for (int i = 0; i < 10; i++) {
				int index = random.nextInt(CHARACTERS.length());
				char randomChar = CHARACTERS.charAt(index);
				sb.append(randomChar);
			}
			String id = sb.toString();
			UserEntity userEntity = null;
			userEntity = userRepo.findByUserName(userName);
		
			entity.setId(Long.parseLong(id));
		
			
			entity.setAmountReceived(request.getAmountReceived());
			entity.setTotalAmount(request.getTotalAmount());
			entity.setChangeReturn(request.getChangeReturn());
			entity.setCustomerId(request.getCustomerId());
			entity.setAgentId(userEntity.getAgentId());
			entity.setAgentName(userName);
			entity.setReceiptNo(request.getReceiptNo());
			entity.setCreatedAt(LocalDateTime.now());
			System.out.println("denomination entty====" + entity);
			denominationRepository.save(entity);
		
	}

	public List<DenominationRequest> getDenominationInfoList(DenominationRequest denomination, String userName) {
		List<Denomination> denominationEntityList = null;
		UserEntity userEntity = null;

		userEntity = userRepo.findByUserName(userName);

		String agentId = userEntity.getAgentId();
		String agentName = userName;
//		System.out.println("agentId in collection list----------" + agentId);
		System.out.println("agentName in collection list----------" + agentName);
		
//		List<Denomination> denominationEntities = denominationRepository.findAll(Sort.by("receiptNo")); // or your custom query

		List<Denomination> denominationEntities = denominationRepository.findInfoByAgentName(agentName);// or your custom query

		// Group by receiptNo (or a composite key if needed)
		Map<String, List<Denomination>> groupedByReceipt = denominationEntities.stream()
		        .collect(Collectors.groupingBy(Denomination::getReceiptNo));

		List<DenominationRequest> DenominationModelList = new ArrayList<>();

		for (Map.Entry<String, List<Denomination>> entry : groupedByReceipt.entrySet()) {
		    List<Denomination> group = entry.getValue();
		    if (group.isEmpty()) continue;

		    Denomination first = group.get(0); // assume all share the same meta-data (agent, customer, etc.)

		    DenominationRequest req = new DenominationRequest();
		    req.setReceiptNo(first.getReceiptNo());
//		    req.setCustomerId(first.getCustomerId());
//		    req.setAccountCode(first.getAccountCode());
//		    req.setAgentId(first.getAgentId());
		    req.setAgentName(first.getAgentName());
		    req.setAmountReceived(first.getAmountReceived());
		    req.setTotalAmount(first.getTotalAmount());
		    req.setChangeReturn(first.getChangeReturn());

		    List<DenominationRequest.NoteEntry> notes = group.stream()
		            .map(e -> {
		                DenominationRequest.NoteEntry note = new DenominationRequest.NoteEntry();
		                note.setValue(e.getNoteValue());
		                note.setCount(e.getNoteCount());
		                return note;
		            })
		            .collect(Collectors.toList());

		    req.setDenominations(notes);
		    DenominationModelList.add(req);
		}
		
		
		/*
		 * denominationEntityList = denominationRepository.findAll();
		 * 
		 * List<DenominationRequest> DenominationModelList = new ArrayList<>();
		 * 
		 * denominationEntityList.stream().forEach(denominationEntity -> {
		 * DenominationRequest denominationModel = new DenominationRequest();
		 * denominationModel.setAgentName(denominationEntity.getAgentName());
		 * denominationModel.setReceiptNo(denominationEntity.getReceiptNo());
		 * denominationModel.setAmountReceived(denominationEntity.getAmountReceived());
		 * denominationModel.setTotalAmount(denominationEntity.getTotalAmount());
		 * denominationModel.setChangeReturn(denominationEntity.getChangeReturn());
		 * 
		 * 
		 * SimpleDateFormat inputFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
		 * SimpleDateFormat outputFormat = new SimpleDateFormat("dd-MM-yyyy"); String
		 * collectionDate = collectionEntity.getCollectionDate(); try { Date date =
		 * inputFormat.parse(collectionDate); String outputDate =
		 * outputFormat.format(date); collectionModel.setCollectionDate(outputDate); }
		 * catch (Exception e) { e.printStackTrace(); }
		 * 
		 * DenominationModelList.add(denominationModel);
		 * 
		 * // System.out.println("collectionInfo collection date-----" +
		 * collectionDate); });
		 */

		return DenominationModelList;
	}

	
	
	
	
	public List<DenominationViewEntity> getDenominationViewList( String userName) {
		List<DenominationViewEntity> denominationEntityList = null;
		UserEntity userEntity = null;

		userEntity = userRepo.findByUserName(userName);

		String agentName = userName;
//		System.out.println("agentId in collection list----------" + agentId);
		System.out.println("agentName in collection list----------" + agentName);
		
//		List<Denomination> denominationEntities = denominationRepository.findAll(Sort.by("receiptNo")); // or your custom query

		List<DenominationViewEntity> denominationEntities = denominationviewRepository.findInfoByAgentName(agentName);// or your custom query

		// Group by receiptNo (or a composite key if needed)
		
		
		System.out.println("denominationEntities  list----------" + denominationEntities);



		return denominationEntities;
	}
	
}
