package com.idsspl.webproject.serviceImpl;

import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.idsspl.webproject.entity.CollectionInfoEntity;
import com.idsspl.webproject.entity.Denomination;
import com.idsspl.webproject.entity.UserEntity;
import com.idsspl.webproject.model.CollectionInfoModel;
import com.idsspl.webproject.model.DenominationRequest;
import com.idsspl.webproject.repo.DenominationRepository;
import com.idsspl.webproject.repo.UserRepo;

@Service

public class DenominationServiceImpl {

	@Autowired
	private DenominationRepository denominationRepository;

	@Autowired
	private UserRepo userRepo;
	
	public void save(DenominationRequest request, String userName) {
		for (DenominationRequest.NoteEntry note : request.getDenominations()) {
			Denomination entity = new Denomination();
			
		///// TO GENERATE THE RANDOM UNIQUE ID
			String CHARACTERS = "0123456789";
			Random random = new Random();
			StringBuilder sb = new StringBuilder(10);
			for (int i = 0; i < 10; i++) {
				int index = random.nextInt(CHARACTERS.length());
				char randomChar = CHARACTERS.charAt(index);
				sb.append(randomChar);
			}
			String id = sb.toString();
			
			UserEntity userEntity = null;
			userEntity = userRepo.findByUserName(userName);
			entity.setAgentId(userEntity.getAgentId());
			
			entity.setId(Long.parseLong(id));
			System.out.println("===note.getValue()==="+note.getValue());
			entity.setNoteValue(note.getValue());
			entity.setNoteCount(note.getCount());
			entity.setAmountReceived(request.getAmountReceived());
			entity.setTotalAmount(request.getTotalAmount());
			entity.setChangeReturn(request.getChangeReturn());
			entity.setCustomerId(request.getCustomerId());
			entity.setAgentName(userName);
			entity.setReceiptNo(request.getReceiptNo());
			entity.setCreatedAt(LocalDateTime.now());
			System.out.println("denomination entty===="+entity);
			denominationRepository.save(entity);
		}
	}
	
	
	
	
	
	public List<DenominationRequest> getDenominationInfoList(DenominationRequest denomination, String userName) {
		List<Denomination> denominationEntityList = null;
		UserEntity userEntity = null;

		userEntity = userRepo.findByUserName(userName);

		String agentId = userEntity.getAgentId();
		String agentName = userName;
//		System.out.println("agentId in collection list----------" + agentId);
		System.out.println("agentName in collection list----------" + agentName);
		denominationEntityList = denominationRepository.findAll();

		List<DenominationRequest> DenominationModelList = new ArrayList<>();

		denominationEntityList.stream().forEach(collectionEntity -> {
			CollectionInfoModel collectionModel = new CollectionInfoModel();
			collectionModel.setCustomerId(collectionEntity.getCustomerId());
			collectionModel.setCollectionAmount(collectionEntity.getCollectionAmount());
			collectionModel.setReceiptNo(collectionEntity.getReceiptNo());
			collectionModel.setLocalLanguageName(collectionEntity.getLocalLanguageName());
			collectionModel.setPaymentMethod(collectionEntity.getPaymentMethod());

			SimpleDateFormat inputFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
			SimpleDateFormat outputFormat = new SimpleDateFormat("dd-MM-yyyy");
			String collectionDate = collectionEntity.getCollectionDate();
			try {
				Date date = inputFormat.parse(collectionDate);
				String outputDate = outputFormat.format(date);
				collectionModel.setCollectionDate(outputDate);
			} catch (Exception e) {
				e.printStackTrace();
			}
			DenominationModelList.add(collectionModel);

			System.out.println("collectionInfo customer Id---------" + collectionEntity.getCustomerId());
			System.out.println("collectionInfo collection amount---" + collectionEntity.getCollectionAmount());
			System.out.println("collectionInfo receipt no----------" + collectionEntity.getReceiptNo());
			System.out.println("collectionInfo name----------------" + collectionEntity.getLocalLanguageName());
			System.out.println("collectionInfo payment method----------------" + collectionEntity.getPaymentMethod());
			System.out.println("collectionInfo collection date-----" + collectionDate);
		});

		return DenominationModelList;
	}
	
}
